FROM alpine:3.17.2 AS build
RUN apk add meson libgcc musl-dev gcc g++ upx linux-headers valgrind
COPY . /code
RUN mkdir /build
WORKDIR /code
RUN LDFLAGS='-static' meson /build/code --default-library static
WORKDIR /build/code
RUN ninja
RUN mkdir /install
RUN cp -r /build /build_tmp
RUN rm -rf /build && mv /build_tmp /build
RUN apk add valgrind

FROM scratch AS export-stage
COPY --from=build install/usr/local/bin/wart-node ./wart-node-linux-debug
COPY --from=build install/usr/local/bin/wart-wallet ./wart-wallet-linux-debug

VOLUME ["/warthog/.warthog"]
ENTRYPOINT ["valgrind", "/build/code/src/node/wart-node", "--chain-db=/warthog/.warthog/chain.db", "--peers-db=/warthog/.warthog/peers.db"]
EXPOSE 9186 3000
